name: GasAgent

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  AWS_REGION: eu-central-1
  ECR_REPOSITORY: ai-agent-app
  ECS_CLUSTER: ai-agent-tutorial-cluster
  ECS_SERVICE: ai-agent-tutorial-service
  TERRAFORM_DIR: terraform
  TERRAFORM_BOOTSTRAP_DIR: terraform-bootstrap
 

permissions:
  id-token: write  # Required for OIDC authentication
  contents: read

jobs:
  bootstrap-state:
    name: Bootstrap Terraform Remote State Backend
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::640706953781:role/terraform-github-deployer
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      - name: Terraform Init (Bootstrap)
        working-directory: ${{ env.TERRAFORM_BOOTSTRAP_DIR }}
        run: terraform init
      - name: Terraform Plan (Bootstrap)
        working-directory: ${{ env.TERRAFORM_BOOTSTRAP_DIR }}
        run: terraform plan
      - name: Terraform Apply (Bootstrap)
        working-directory: ${{ env.TERRAFORM_BOOTSTRAP_DIR }}
        run: terraform apply -auto-approve
      - name: Bootstrap Complete
        run: |
          echo "‚úÖ Remote state backend infrastructure created successfully!"
          echo "üì¶ S3 Bucket: terraform-state-021580456215-ai-agent-infra"
          echo "üîí DynamoDB Table: terraform-state-lock"
          echo ""
          echo "You can now run the main deployment workflow."

  build-and-deploy:
    name: Build & Deploy to AWS
    runs-on: ubuntu-latest
    needs: [bootstrap-state]
    if: always() && (needs.bootstrap-state.result == 'success' || needs.bootstrap-state.result == 'skipped')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Configure AWS Credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::640706953781:role/terraform-github-deployer
          aws-region: ${{ env.AWS_REGION }}
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
      - name: Debug - List existing ALBs
        run: |
          echo "=== Existing Application Load Balancers ==="
          aws elbv2 describe-load-balancers --region ${{ env.AWS_REGION }} --output table || true
          echo "=========================================="
      - name: Debug - Verify AWS Identity
        run: |
          echo "=== AWS Caller Identity ==="
          aws sts get-caller-identity
      - name: Debug - Check Terraform Backend Configuration
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          echo "=== Checking for old bucket references ==="
          grep -R "terraform-state-adriangulyas-ai-agent" -n . || true
          echo ""
          echo "=== Terraform files that mention terraform-state ==="
          grep -R "terraform-state" -n . || true
          echo ""
          echo "=== backend.tf content ==="
          head -n 20 backend.tf || true
      - name: Safety Check - Verify Remote State Backend Exists
        run: |
          echo "üîç Checking if remote state backend infrastructure exists..."
          if aws s3api head-bucket --bucket terraform-state-640706953781-gasagent2 2>/dev/null; then
            echo "‚úÖ S3 bucket exists"
          else
            echo "‚ùå ERROR: S3 bucket 'terraform-state-640706953781-gasagent2' does not exist!"
            echo ""
            echo "Please run the bootstrap job first:"
            echo "1. Go to Actions tab"
            echo "2. Select 'GasAgent' workflow"
            echo "3. Click 'Run workflow'"
            echo "4. This will create the S3 bucket and DynamoDB table for remote state"
            exit 1
          fi
          
          if aws dynamodb describe-table --table-name terraform-state-lock --region eu-central-1 2>/dev/null; then
            echo "‚úÖ DynamoDB table exists"
          else
            echo "‚ö†Ô∏è  WARNING: DynamoDB table 'terraform-state-lock' does not exist!"
            echo "State locking will not work. Please run the bootstrap job."
          fi
      - name: Terraform Init
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform init -reconfigure \
            -backend-config="bucket=terraform-state-640706953781-gasagent2" \
            -backend-config="key=cost-optimization/terraform.tfstate" \
            -backend-config="region=eu-central-1" \
            -backend-config="dynamodb_table=terraform-state-lock" \
            -backend-config="encrypt=true"
      - name: Remove ALB resources from Terraform state (TEMPORARY)
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: |
          terraform state rm aws_lb.main || true
          terraform state rm aws_lb_target_group.main || true
          terraform state rm aws_lb_listener.main || true
      - name: Terraform Refresh
        working-directory: ${{ env.TERRAFORM_DIR }}
        run: terraform refresh -lock=false
        env:
          TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
      - name: Terraform Plan
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        run: terraform plan -out=tfplan
      - name: Terraform Apply
        working-directory: ${{ env.TERRAFORM_DIR }}
        env:
          TF_VAR_openai_api_key: ${{ secrets.OPENAI_API_KEY }}
        run: terraform apply -auto-approve tfplan
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Build Docker image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f backend/Dockerfile backend
          docker tag $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPOSITORY:latest
      - name: Push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
      - name: Force ECS Service Deployment
        run: |
          aws ecs update-service \
            --cluster $ECS_CLUSTER \
            --service $ECS_SERVICE \
            --force-new-deployment \
            --region $AWS_REGION
          echo "‚úÖ Triggered ECS service deployment"
      - name: Wait for deployment to complete
        run: |
          aws ecs wait services-stable \
            --cluster $ECS_CLUSTER \
            --services $ECS_SERVICE \
            --region $AWS_REGION
      - name: Get Application URL
        run: |
          ALB_DNS=$(aws elbv2 describe-load-balancers \
            --query 'LoadBalancers[?contains(LoadBalancerName, `ai-agent-tutorial`)].DNSName' \
            --output text \
            --region $AWS_REGION)
          echo "üöÄ Deployment successful!"
          echo "üìç Application URL: http://$ALB_DNS"
          echo "üìä Grafana Dashboard: http://$ALB_DNS:3000"
          echo "üîë Grafana credentials: admin/admin"
